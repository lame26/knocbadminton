# KNOC 배드민턴 월례대회/회원관리 프로그램 분석 메모

작성일: 2026-02-26

## 1) 프로젝트 개요
- Streamlit 기반 웹 앱이며 로그인 후 권한(슈퍼관리자/관리자/선수)에 따라 페이지 메뉴가 달라집니다.
- 기능 축은 **선수 관리 / 대진 생성 / 경기결과 승인 워크플로우 / 랭킹 및 통계**입니다.
- 현재 코드는 SQLite 설명이 README에 남아 있으나, 실제 `Database` 구현은 Supabase를 사용하도록 전환되어 있습니다.

## 2) 진입점 및 구조
- 엔트리: `app.py`
  - 세션 초기화(`authenticated`, `role`, `emp_id`, `username`)
  - `DataManager`를 세션 싱글턴으로 사용
  - 사이드바 메뉴에서 페이지 라우팅
- 업무 로직: `data_manager.py`
  - 인증/선수 CRUD/대진 생성/결과 반영/승인·이의제기/백업·복구
- 저장소 계층: `database.py`
  - Supabase 테이블 CRUD 래핑
- 페이지 모듈: `pages/*.py`
  - `page_tourney.py`: 대진 생성
  - `page_my_matches.py`: 선수 점수 입력
  - `page_mediate.py`: 관리자 중재
  - `page_manage.py`: 선수 관리, 점수 재계산/초기화

## 3) 데이터 모델 요약
- `players`: 사번(emp_id) PK, 이름, 점수, 티어, 활동여부, 경기 누적 통계, 역할(role)
- `matches`: 날짜/조/양팀 선수/스코어/변동점수/상태/입력·승인 메타
- `settings`: super_admin 설정(아이디/해시 비밀번호)
- `score_rules`, `tier_rules`: 점수 및 티어 규칙

## 4) 핵심 워크플로우
1. 선수는 `이름 + 사번`, 슈퍼관리자는 `admin + 비밀번호`로 로그인.
2. 선수가 경기 점수 입력 시 `pending_approval`로 저장.
3. 상대팀 승인 시 `done`으로 확정되며 점수/티어 재계산.
4. 이의제기 시 `disputed` 상태로 이동 후 관리자 중재 가능.

## 5) 코드 상태 진단 (중요)

### A. 문서/구현 불일치
- README는 SQLite 기반으로 설명하지만, 실제 `database.py`는 Supabase를 사용함.
- 신규 인수인계 관점에서 가장 먼저 정리해야 할 항목.

### B. 민감정보 노출
- `migrate_to_supabase.py`에 Supabase URL/anon key가 하드코딩됨.
- 공개 저장소 기준 즉시 키 교체/폐기와 비밀관리 방식 전환이 필요.

### C. 보안 설정 리스크
- `supabase_setup.sql`에서 모든 핵심 테이블 RLS를 비활성화.
- 현재 구조는 사실상 anon 키만 알면 폭넓은 읽기/쓰기 가능해질 수 있어 운영 리스크 큼.

### D. 백업/복구 로직의 기술부채
- `DataManager.create_backup()`은 로컬 DB 파일 복사를 전제로 작성되어 있음.
- 현재 DB 추상화가 Supabase인 상태에서는 실질 백업이 동작하지 않을 가능성이 높음.

### E. 예외 삼킴(관측성 부족)
- `database.py` 다수 메서드가 broad `except Exception: return False/None` 패턴.
- 장애 시 원인 추적이 어려워 운영 디버깅 비용이 커짐.

## 6) 우선순위 개선 제안 (실행순)
1. **보안 조치 즉시**
   - 노출 키 회수/재발급, 코드에서 하드코딩 제거, 환경변수/Secrets만 사용.
   - Supabase RLS 정책 설계 및 최소권한 적용.
2. **문서 정합성 복구**
   - README를 현재 아키텍처(Supabase) 기준으로 전면 갱신.
3. **운영 가시성 개선**
   - DB 계층의 예외 로깅 추가(메서드/파라미터/응답코드).
4. **백업 정책 재설계**
   - Supabase 스냅샷/덤프 또는 관리 스크립트 기반 백업으로 전환.
5. **테스트 자동화**
   - 점수 계산, 승인/중재 상태전이, 대진 생성에 대한 단위테스트 추가.

## 7) 빠른 재가동 체크리스트
- `.streamlit/secrets.toml` 또는 환경변수에 `SUPABASE_URL`, `SUPABASE_KEY` 준비
- `pip install -r requirements.txt`
- `streamlit run app.py`
- 관리자 로그인 및 주요 페이지(랭킹/대진/선수관리/중재) smoke test


## 8) Streamlit → Cloudflare + Supabase 전환 고도화 제안 (보안 제외)

아래는 기능/제품 완성도를 높이기 위한 전환 로드맵입니다. (보안 항목은 의도적으로 제외)

### 8-1. 목표 아키텍처
- 프론트엔드: React(Next.js) + TypeScript + Tailwind + shadcn/ui
- API/BFF: Cloudflare Workers(Hono 또는 Remix on Workers)
- 데이터: Supabase(Postgres + Realtime)
- 파일/리포트: Cloudflare R2
- 캐시/세션: Cloudflare KV 또는 Durable Objects
- 모니터링: Sentry + Cloudflare Analytics + PostHog(선택)

### 8-2. 기능 고도화 방향

#### A. 대회 운영 고도화
1. 시즌/월례대회 분리 모델
   - `season`, `tournament`, `round`, `match` 계층화
   - 월례와 연간 랭킹 동시 집계
2. 자동 편성 엔진 v2
   - 현재 점수 기반 밸런싱 + 최근 파트너 중복 회피 + 휴식 횟수 균등화
   - 조별/스위스/리그전 포맷 선택
3. 결과 확정 파이프라인 개선
   - 임시저장 → 검토 → 확정 → 정정이력(버전) 추적
   - 중재 시 '원본 점수/수정 점수/사유' 비교 뷰

#### B. 회원/활동 데이터 고도화
1. 선수 프로필 확장
   - 주 포지션, 선호 파트너, 출전 가능 요일, 최근 컨디션
2. 출석/참여 분석
   - 월별 참여율, 연속참여, 노쇼율, 출전 예측
3. 실력지표 다변화
   - 단순 점수 + 폼 지수(최근 N경기 가중치) + 파트너 시너지 지표

#### C. 운영 편의 기능
1. 관리자용 "대회 당일 모드"
   - 체크인 보드, 코트 배정, 경기 호출 상태판
2. 일괄 입력/수정 도구
   - CSV 업로드, 다건 스코어 수정, 선수 대량 등록
3. 리포트 자동화
   - 월례 결과 PDF/웹 리포트 자동 생성 및 링크 공유

#### D. 사용자 경험(UX) 고도화
1. 개인 대시보드
   - 내 랭킹 추이, 최근 전적, 이번 달 목표 달성도
2. 알림 체계
   - 경기 입력 요청, 승인 대기, 대회 공지(웹 푸시/카카오 알림톡 연동 가능)
3. 검색/필터 고도화
   - 선수/월/조/상태 복합 필터 + 저장된 뷰

### 8-3. UI/디자인 가이드 (이모지 없는 세련형)
- 비주얼 원칙
  - 이모지/장식성 아이콘 지양, 라인 아이콘(예: Lucide) 최소 사용
  - 블루/슬레이트 중심의 단색 계열 + 포인트 컬러 1개
  - 카드/테이블 밀도는 "모바일-데스크탑" 반응형으로 단계화
- 타이포/컴포넌트
  - 프리텐다드(Pretendard) 또는 Inter, 8pt spacing system
  - 버튼 3단계(Primary/Secondary/Ghost), 상태 배지는 텍스트 우선
- 정보 구조
  - 상단: 핵심 KPI
  - 중단: 오늘 경기/승인대기/이의제기
  - 하단: 상세 테이블/히스토리
- 접근성
  - 색상 대비 WCAG AA, 키보드 내비게이션, 폼 에러 문구 표준화

### 8-4. 단계별 마이그레이션 계획

#### Phase 0. 도메인 정리 (1~2주)
- 기존 Streamlit 기능을 도메인 단위로 분해: 인증/선수/대진/결과/중재/설정
- Supabase 스키마 리팩터링 초안(시즌/대회/라운드 분리)
- API 계약서(OpenAPI) 작성

#### Phase 1. 병행 운영 기반 구축 (2~3주)
- Workers API 골격 + 공통 에러 포맷 + 페이지네이션 규약
- Next.js 프로젝트 초기화 및 디자인 토큰/컴포넌트 시스템 구축
- Streamlit과 동일 데이터 읽기(읽기 전용)로 화면 검증

#### Phase 2. 핵심 기능 이관 (3~5주)
- 랭킹/대진 조회/선수 프로필/내 경기 입력 이관
- 승인/중재 상태머신 API 이관
- 점수 계산 엔진 서비스화(순수 함수 + 테스트)

#### Phase 3. 고도화 기능 적용 (3~4주)
- 자동 편성 엔진 v2, 당일 운영 모드, 리포트 자동화
- 분석 대시보드 및 활동지표 추가
- 사용자 피드백 반영 UI polish

#### Phase 4. 전환 완료 (1~2주)
- Streamlit read-only 전환 후 종료
- 운영 매뉴얼/인수인계 문서 확정
- 월례대회 1회 실전 리허설 후 정식 전환

### 8-5. 성공지표(KPI) 제안
- 운영 효율: 대진 생성~확정까지 소요시간 30% 단축
- 입력 품질: 점수 정정률 50% 감소
- 사용자 사용성: 월간 활성 사용자(MAU), 재방문율 증가
- 데이터 활용: 월례 리포트 자동 생성률 100%

### 8-6. 우선 구현 백로그 (빠른 체감순)
1. 모바일 친화 "당일 운영 보드"
2. 승인 대기/이의제기 통합 인박스
3. 시즌/월례 분리 랭킹
4. 자동 편성 엔진 v2
5. 개인 성과 대시보드
